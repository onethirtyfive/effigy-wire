#!/usr/bin/env ruby

PROTO_ROOT =
  begin
    ENV.fetch('PROTO_ROOT')
  rescue KeyError
    File.join(Dir.pwd, 'proto')
  end

Dir.glob(File.join(PROTO_ROOT, '**/*')).each do |proto_path|
  next if File.directory?(proto_path)

  puts "> Tweaking #{File.basename(proto_path)}"
  cmd = <<-EOV
    sed -i \
        -e '/optional/ s/optional \\./optional /' \
        -e '/repeated/ s/repeated \\./repeated /' \
        -e '/k_EHero/ s/k_EHero/K_EHero/' \
        -e '/kPVLS/ s/kPVLS/KPVLS/' \
        -e '/k_EDOTA/ s/k_EDOTA/K_EDOTA/' \
        -e '/k_eResult/ s/k_eResult/K_eResult/' \
        -e '/ePE_/ s/ePE_/EPE_/' \
        -e '/net_/ s/net_/NET_/' \
        -e '/svc_/ s/svc_/SVC_/' \
        -e '/require\s+''.*..pb''/ s/require/require_relative/' \
        #{proto_path}
  EOV
  system(cmd)
end

